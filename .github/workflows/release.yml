name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get current version and auto-bump if needed
        id: get_version
        run: |
          # Extract current version from plugin header
          CURRENT_VERSION=$(grep -m 1 "Version:" bwg-instagram-feed.php | sed 's/.*Version: *\([0-9.]*\).*/\1/')

          if [ -z "$CURRENT_VERSION" ]; then
            echo "::error::Could not extract version from plugin header"
            exit 1
          fi

          echo "Current version in file: $CURRENT_VERSION"

          # Check if this version tag already exists
          if git ls-remote --tags origin | grep -q "refs/tags/v${CURRENT_VERSION}$"; then
            echo "Version v${CURRENT_VERSION} already released. Auto-bumping patch version..."

            # Parse version components
            MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
            MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
            PATCH=$(echo $CURRENT_VERSION | cut -d. -f3)

            # Increment patch
            NEW_PATCH=$((PATCH + 1))
            NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"

            echo "New version: $NEW_VERSION"

            # Update version in plugin file header
            sed -i "s/Version: *${CURRENT_VERSION}/Version: ${NEW_VERSION}/" bwg-instagram-feed.php

            # Update BWG_IGF_VERSION constant
            sed -i "s/define( 'BWG_IGF_VERSION', '${CURRENT_VERSION}' )/define( 'BWG_IGF_VERSION', '${NEW_VERSION}' )/" bwg-instagram-feed.php

            # Update readme.txt stable tag
            if [ -f "readme.txt" ]; then
              sed -i "s/Stable tag: *${CURRENT_VERSION}/Stable tag: ${NEW_VERSION}/" readme.txt
            fi

            # Commit the version bump
            git add bwg-instagram-feed.php readme.txt
            git commit -m "Bump version to ${NEW_VERSION} [skip ci]"
            git push

            VERSION="$NEW_VERSION"
          else
            VERSION="$CURRENT_VERSION"
          fi

          echo "=========================================="
          echo "Release version: $VERSION"
          echo "=========================================="
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT

      - name: Create plugin zip
        run: |
          set -e
          VERSION="${{ steps.get_version.outputs.VERSION }}"

          echo "Creating distribution directory..."
          mkdir -p dist/bwg-instagram-feed

          # Verify required files exist
          for file in bwg-instagram-feed.php uninstall.php; do
            if [ ! -f "$file" ]; then
              echo "::error::Required file missing: $file"
              exit 1
            fi
          done

          for dir in assets includes templates; do
            if [ ! -d "$dir" ]; then
              echo "::error::Required directory missing: $dir"
              exit 1
            fi
          done

          # Copy production files only
          cp bwg-instagram-feed.php dist/bwg-instagram-feed/
          cp uninstall.php dist/bwg-instagram-feed/
          [ -f "readme.txt" ] && cp readme.txt dist/bwg-instagram-feed/
          [ -f "README.md" ] && cp README.md dist/bwg-instagram-feed/

          cp -r assets dist/bwg-instagram-feed/
          cp -r includes dist/bwg-instagram-feed/
          cp -r templates dist/bwg-instagram-feed/
          [ -d "languages" ] && cp -r languages dist/bwg-instagram-feed/

          # Create zip
          cd dist
          zip -r "bwg-instagram-feed-${VERSION}.zip" bwg-instagram-feed
          cp "bwg-instagram-feed-${VERSION}.zip" bwg-instagram-feed.zip

          echo "✓ Plugin zip created: bwg-instagram-feed-${VERSION}.zip"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.VERSION }}
          name: BWG Instagram Feed v${{ steps.get_version.outputs.VERSION }}
          generate_release_notes: true
          body: |
            ## BWG Instagram Feed v${{ steps.get_version.outputs.VERSION }}

            ### Installation
            1. Download `bwg-instagram-feed.zip`
            2. Go to WordPress Admin → Plugins → Add New → Upload Plugin
            3. Upload the zip file and activate

            ---
            **Changelog** (auto-generated from commits below)
          files: |
            dist/bwg-instagram-feed-${{ steps.get_version.outputs.VERSION }}.zip
            dist/bwg-instagram-feed.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
