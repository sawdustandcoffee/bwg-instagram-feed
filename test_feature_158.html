<!DOCTYPE html>
<html>
<head>
    <title>Feature #158 Test: Image Proxy Error Handling</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .test-section h2 { margin-top: 0; }
        .image-container { width: 200px; height: 200px; border: 2px solid #333; display: inline-block; margin: 10px; }
        .image-container img { width: 100%; height: 100%; object-fit: contain; }
        .pass { color: green; font-weight: bold; }
        .fail { color: red; font-weight: bold; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Feature #158 Test: Image Proxy Error Handling</h1>
    <p>This test verifies that the image proxy handles download failures gracefully.</p>

    <div class="test-section">
        <h2>Test 1: Proxy with invalid/non-existent Instagram URL</h2>
        <p>The proxy should return a placeholder SVG image when the original image cannot be fetched.</p>
        <p><strong>URL being tested:</strong> <code>https://scontent.cdninstagram.com/nonexistent/does-not-exist.jpg</code></p>
        <div class="image-container">
            <img id="test1-img"
                 src="http://localhost:8088/wp-json/bwg-igf/v1/proxy/image?url=https%3A%2F%2Fscontent.cdninstagram.com%2Fnonexistent%2Fdoes-not-exist.jpg"
                 alt="Testing placeholder"
                 onload="document.getElementById('test1-result').innerHTML = '<span class=pass>✅ PASS: Image loaded (placeholder SVG)</span>'"
                 onerror="document.getElementById('test1-result').innerHTML = '<span class=fail>❌ FAIL: Image failed to load</span>'">
        </div>
        <p id="test1-result">Loading...</p>
    </div>

    <div class="test-section">
        <h2>Test 2: Proxy with another invalid Instagram URL (404 simulation)</h2>
        <p>Testing with a URL that should return 404 from Instagram CDN.</p>
        <div class="image-container">
            <img id="test2-img"
                 src="http://localhost:8088/wp-json/bwg-igf/v1/proxy/image?url=https%3A%2F%2Fscontent-iad3-1.cdninstagram.com%2Fv%2Ft51.2885-15%2F00000000_000000000_000000000_n.jpg"
                 alt="Testing placeholder"
                 onload="document.getElementById('test2-result').innerHTML = '<span class=pass>✅ PASS: Image loaded (placeholder SVG)</span>'"
                 onerror="document.getElementById('test2-result').innerHTML = '<span class=fail>❌ FAIL: Image failed to load</span>'">
        </div>
        <p id="test2-result">Loading...</p>
    </div>

    <div class="test-section">
        <h2>Test 3: Valid working image (control test)</h2>
        <p>This should load a working image from picsum.photos through the proxy.</p>
        <div class="image-container">
            <img id="test3-img"
                 src="http://localhost:8088/wp-json/bwg-igf/v1/proxy/image?url=https%3A%2F%2Fpicsum.photos%2F200"
                 alt="Working image test"
                 onload="document.getElementById('test3-result').innerHTML = '<span class=pass>✅ PASS: Working image loaded successfully</span>'"
                 onerror="document.getElementById('test3-result').innerHTML = '<span class=fail>❌ FAIL: Working image failed to load</span>'">
        </div>
        <p id="test3-result">Loading...</p>
    </div>

    <div class="test-section">
        <h2>Test 4: Feed display resilience</h2>
        <p>Simulating a feed grid with mixed valid and invalid images. The feed should still display properly with placeholders for failed images.</p>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-width: 650px;">
            <div class="image-container">
                <img src="http://localhost:8088/wp-json/bwg-igf/v1/proxy/image?url=https%3A%2F%2Fpicsum.photos%2F200%3Frandom%3D1" alt="Image 1">
            </div>
            <div class="image-container">
                <img src="http://localhost:8088/wp-json/bwg-igf/v1/proxy/image?url=https%3A%2F%2Fscontent.cdninstagram.com%2Ffailed%2F1.jpg" alt="Failed 1">
            </div>
            <div class="image-container">
                <img src="http://localhost:8088/wp-json/bwg-igf/v1/proxy/image?url=https%3A%2F%2Fpicsum.photos%2F200%3Frandom%3D2" alt="Image 2">
            </div>
            <div class="image-container">
                <img src="http://localhost:8088/wp-json/bwg-igf/v1/proxy/image?url=https%3A%2F%2Fscontent.cdninstagram.com%2Ffailed%2F2.jpg" alt="Failed 2">
            </div>
            <div class="image-container">
                <img src="http://localhost:8088/wp-json/bwg-igf/v1/proxy/image?url=https%3A%2F%2Fpicsum.photos%2F200%3Frandom%3D3" alt="Image 3">
            </div>
            <div class="image-container">
                <img src="http://localhost:8088/wp-json/bwg-igf/v1/proxy/image?url=https%3A%2F%2Fscontent.cdninstagram.com%2Ffailed%2F3.jpg" alt="Failed 3">
            </div>
        </div>
        <p><strong>Expected:</strong> Grid should display with alternating working images and gray placeholder images.</p>
    </div>

    <div class="test-section">
        <h2>Summary</h2>
        <p>Feature #158 requirements:</p>
        <ul>
            <li>✅ When the proxy cannot download an Instagram image (network error, 404, rate limited), it returns a placeholder image</li>
            <li>✅ Frontend feed still displays with placeholder for failed images (grid doesn't break)</li>
            <li>✅ Errors are logged for debugging (check WordPress debug.log)</li>
        </ul>
    </div>

    <script>
        // Add a timeout check
        setTimeout(function() {
            ['test1-result', 'test2-result', 'test3-result'].forEach(function(id) {
                var el = document.getElementById(id);
                if (el && el.innerHTML === 'Loading...') {
                    el.innerHTML = '<span class="fail">⚠️ Timeout: Image load still pending</span>';
                }
            });
        }, 30000);
    </script>
</body>
</html>
